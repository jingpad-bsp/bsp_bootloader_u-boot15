#include <asm/arch/common.h>
#include <asm/arch/sprd_reg.h>
#include <adi_hal_internal.h>

#define REF_OUT_26M_EN				0x3
#define CONFIG_SPRDCHG_I2C_BUS			6
#define I2C_SPEED				100000
#define SLAVE_ADDR				0x49
#define BUCK_ADDR				0x03
#define BUCK_VALUE_1_1				0x50
#define BUCK_VALUE_0_8				0x32
#define ROC1_CHIP_VER_AA			1
#define ROC1_CHIP_VER_AB			3

#define UP1106E_CNFG_ADDR			0x2
#define UP1106E_I2C_SPEED			100000
#define UP1106E_SLAVE_ADDR			0x60
#define CONFIG_UP1106E_I2C_BUS			6

#define CHP2630_CNFG_ADDR			0x45
#define CHP2630_I2C_SPEED			100000
#define CHP2630_SLAVE_ADDR			0x26
#define CONFIG_CHP2630_I2C_BUS			5

#define UP1106E_SLEW_OPT(x)			((x & 0x7) << 4)
#define UP1106E_OUTPUT_DISCHARGE(x)		((x & 0x1) << 7)

#define CHP2630_SLEW_OPT(x)			(x & 0x7)
#define CHP2630_VOUT_MIN(x)			((x & 0x1) << 3)

#define UP1106E_DATA_REGCONFG(a,b)		(UP1106E_SLEW_OPT(a) | UP1106E_OUTPUT_DISCHARGE(b))
#define CHP2630_DATA_REGCONFG(a,b)		(CHP2630_SLEW_OPT(a) | CHP2630_VOUT_MIN(b))

static int power_on_voltage_init(void)
{
	regulator_set_voltage("vddrf1v25",1100);
	regulator_set_voltage("vddgen1",1300);
	regulator_set_voltage("vddwcn",1000);
	return 0;
}

static int sc2703_set_voltage(u8 reg, u8 val)
{
	i2c_set_bus_num(CONFIG_SPRDCHG_I2C_BUS);
	i2c_init(I2C_SPEED, SLAVE_ADDR);
	i2c_reg_write(SLAVE_ADDR, reg, val);
}

static int up1106E_buck_cfg(u8 reg, u8 slew, u8 vout_min)
{
	i2c_set_bus_num(CONFIG_UP1106E_I2C_BUS);
	i2c_init(UP1106E_I2C_SPEED, UP1106E_SLAVE_ADDR);
	i2c_reg_write(UP1106E_SLAVE_ADDR, reg, UP1106E_DATA_REGCONFG(slew, vout_min));

	return 0;
}

static int chp2630_buck_cfg(u8 reg, u8 slew, u8 output_discharge)
{
	i2c_set_bus_num(CONFIG_CHP2630_I2C_BUS);
	i2c_init(CHP2630_I2C_SPEED, CHP2630_SLAVE_ADDR);
	i2c_reg_write(CHP2630_SLAVE_ADDR, 0x02, 0x00);
	udelay(5);
	i2c_reg_write(CHP2630_SLAVE_ADDR, 0x40, 0x01);
	udelay(5);
	i2c_reg_write(CHP2630_SLAVE_ADDR, 0x00, 0x01);
	udelay(5);
	i2c_reg_write(CHP2630_SLAVE_ADDR, 0x42, 0x8F);
	udelay(5);
	i2c_reg_write(CHP2630_SLAVE_ADDR, reg, CHP2630_DATA_REGCONFG(slew, output_discharge));

	return 0;
}

void up1106E_voltage_slew_rate_cfg()
{
	/* DCDC-CPU0 */
	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU0_VOL_TUNE_UP_CFG0,
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_UP_CFG1_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_UP_CFG0_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU0_VOL_TUNE_UP_CFG1,
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_UP_CFG3_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_UP_CFG2_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU0_VOL_TUNE_UP_CFG2,
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_UP_CFG5_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_UP_CFG4_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU0_VOL_TUNE_UP_CFG3,
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_UP_CFG7_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_UP_CFG6_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)));


	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU0_VOL_TUNE_DOWN_CFG0,
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_DOWN_CFG1_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_DOWN_CFG0_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU0_VOL_TUNE_DOWN_CFG1,
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_DOWN_CFG3_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_DOWN_CFG2_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU0_VOL_TUNE_DOWN_CFG2,
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_DOWN_CFG5_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_DOWN_CFG4_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU0_VOL_TUNE_DOWN_CFG3,
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_DOWN_CFG7_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU0_VOLTAGE_DOWN_CFG6_I2C(UP1106E_DATA_REGCONFG(0x2, 0x1)));
}

void chp2630_voltage_slew_rate_cfg()
{
	/* DCDC-CPU1 */
	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU1_VOL_TUNE_UP_CFG0,
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_UP_CFG1_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_UP_CFG0_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU1_VOL_TUNE_UP_CFG1,
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_UP_CFG3_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_UP_CFG2_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU1_VOL_TUNE_UP_CFG2,
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_UP_CFG5_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_UP_CFG4_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU1_VOL_TUNE_UP_CFG3,
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_UP_CFG7_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_UP_CFG6_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)));


	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU1_VOL_TUNE_DOWN_CFG0,
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_DOWN_CFG1_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_DOWN_CFG0_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU1_VOL_TUNE_DOWN_CFG1,
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_DOWN_CFG3_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_DOWN_CFG2_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU1_VOL_TUNE_DOWN_CFG2,
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_DOWN_CFG5_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_DOWN_CFG4_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)));

	CHIP_REG_SET(REG_TOP_DVFS_APB_PMIC_3RD_CPU1_VOL_TUNE_DOWN_CFG3,
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_DOWN_CFG7_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)) |
		     BIT_TOP_DVFS_APB_DCDC_CPU1_VOLTAGE_DOWN_CFG6_I2C(CHP2630_DATA_REGCONFG(0x2, 0x1)));
}

int regulator_init(void)
{
	power_on_voltage_init();
	/*enable DCXO_26M_REF_OUT*/
	ANA_REG_OR(ANA_REG_GLB_TSX_CTRL0, BITS_DCXO_26M_REF_OUT_EN(REF_OUT_26M_EN));
	/*
	if (ROC1_CHIP_VER_AA == CHIP_REG_GET(REG_AON_APB_AON_VER_ID)) {
		sc2703_set_voltage(BUCK_ADDR, BUCK_VALUE_1_1);
	} else {
		sc2703_set_voltage(BUCK_ADDR, BUCK_VALUE_0_8);
	}
	*/
	up1106E_buck_cfg(UP1106E_CNFG_ADDR, 0x2, 0x1);
	chp2630_buck_cfg(CHP2630_CNFG_ADDR, 0x2, 0x1);

	up1106E_voltage_slew_rate_cfg();
	chp2630_voltage_slew_rate_cfg();
	return 0;
}
